<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Analysis Report</title>
    
    <!-- am4_script DO NOT REMOVE THIS COMMENT -->
    <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
    <!-- am4_script_end DO NOT REMOVE THIS COMMENT -->
  
    <!-- DATA BLOCK -->
    <script type="text/javascript">
        data=/*data DO NOT REMOVE THIS COMMENT*/ 
        [{"datetime":"17/01/25 02:35:26","kmph":0,"distance_meters":0},{"datetime":"17/01/25 02:35:27","kmph":1,"distance_meters":0},{"datetime":"17/01/25 02:35:28","kmph":1,"distance_meters":0},{"datetime":"17/01/25 02:35:29","kmph":1,"distance_meters":1},{"datetime":"17/01/25 02:35:30","kmph":1,"distance_meters":0},{"datetime":"17/01/25 02:35:31","kmph":1,"distance_meters":1},{"datetime":"17/01/25 02:35:32","kmph":1,"distance_meters":0},{"datetime":"17/01/25 02:35:33","kmph":1,"distance_meters":1},{"datetime":"17/01/25 02:35:34","kmph":2,"distance_meters":0},{"datetime":"17/01/25 02:35:35","kmph":2,"distance_meters":1},{"datetime":"17/01/25 02:35:36","kmph":2,"distance_meters":0},{"datetime":"17/01/25 02:35:37","kmph":2,"distance_meters":1},{"datetime":"17/01/25 02:35:38","kmph":2,"distance_meters":1}];
        /*data_end DO NOT REMOVE THIS COMMENT*/
		
		data.forEach(function(item) {
			var parts = item.datetime.split(/[/ :]/);
			// Parse the date in the format: DD/MM/YY HH:mm:ss
			item.date = new Date(
				2000 + parseInt(parts[2], 10), // Year: convert two-digit year to full year
				parseInt(parts[1], 10) - 1,     // Month: zero-indexed (0 = January)
				parseInt(parts[0], 10),         // Day
				parseInt(parts[3], 10),         // Hour
				parseInt(parts[4], 10),         // Minute
				parseInt(parts[5], 10)          // Second
			);
		});
    
    // Recalculate cumulative distance
    var distance = 0;
    data.forEach(function(item) {
        item.distance_cumm = item.distance_meters + distance;
        distance = item.distance_cumm;
        item.distance_cumm_positive = item.distance_cumm;
        item.distance_cumm_positive_comma = (parseFloat(item.distance_cumm_positive) / 1000).toFixed(3);
    });
    
    </script>
    
    <!-- Chart code -->
<!-- DeepSeek changes allowed after this line -->
<style>
@media print {
  #downloadHtmlBtn,
  #printReportBtn {
    display: none !important;
  }
}
</style>
</head>
	
<body align="center"  style="background: linear-gradient(to bottom, #fdfcfb, #e2e1e0);" >
<div id="backendversion" data-value="versionfromthebackend"></div>
<div id="frontendversion" data-value="0.0.1"></div>
<script>
  var backendversion=document.getElementById("backendversion").getAttribute("data-value");
  var frontendversion=document.getElementById("frontendversion").getAttribute("data-value");
  if(backendversion != frontendversion){
    console.log("You are using old software, please download new software.");
  }
  
  var final_report=false;
</script>

<div style="display: flex; align-items: center;justify-content: center;">
  <img style="height: 40px; margin-right: 10px;" alt="Speed Vision" src="data:image/png;base64,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" />  
  <h1 style="margin: 0; font-size: 32px;">SPEEDOMETER DATA ANALYSIS</h1>
</div>


  <br>
  <div id="textdata" style="font-size: 1em;font-weight: bold;">
    <style>
      input[type="text"], textarea {
      font-size: 1.1em;
      font-weight: bold;
      }
      tr{
        text-align: left;
      }
    </style>
      <!-- Filter Form -->
      <div id="filter" style="margin-bottom:20px; align-items: center;justify-content: center; justify-items: center;">
        <div style="display: flex; justify-content: center; text-align: center;">
        <IMG  id="toggleFilterBtn" SRC="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAk5JREFUOE+VU79rVEEQnpm3XN6dhYVoJUryB5zk7Uv0UqjRQqwkMSpYiIWChaigIJo6iBIQVNBKtJCgRKKNYmEUEU8vb99d7h/wB9qphaK3d+7u6B7vQhJPiFssy3yz3858+w3CP5aU8iQzTyIiA8AZpdSVbqnYCRaLxVW5XG6UiB5VKpUvUsqEmY97HBGvKaXiwcHBNcaY3caYmXq9/qON+U1KWQCAJwAgAGADIt6y1h4Lw3C9x1ut1idEvM7MhwHgAwAYANillPrZJoii6AAinlJKDUVRtJmIRq21d6rV6rzH+/v7NyHiQQCYSdP0jZTyFTNfTtP0XpvAl2atrTPz3jRNX/vYwMBAHzMP+zMRzVYqlbfZY1sQ8X4QBEXf6oIGcRxPOOdEmqZnpZT7mDmntX7oL4VhuIeImkmSTMdxfAkAfiVJMt7WQEp5AgAOOed6hRA7AeCbtbZERF+ZeZtPYubnRLSWiF7+KX21MeYpEfmKbnuCFjNv7enpmS+Xy40oio5qrafy+fy4UupcJvKFRqMxUSgU9idJcrNUKuWbzabX5cVfBFLKI2EY3tVan18pQbsFAOhzzg0LIb5ba4cA4DMibs9aeEZE67q20DHSYhHjOB5zzoVa6wceLxQKIwDQ8CJGUXSRiMyCiIu/0Tk3Vq1Wy1ms1zm3w2tojJmt1WrvMk94gaeXfONyIwHASBAEU3Nzc7UVGaljZUQMmHnjcitrrT8GQXDDWxkR3zOzXWJl/4ofJiHEiBDi8X8PU7cxzQw2mWGnlVJXu+X9BuCMaVLQARlOAAAAAElFTkSuQmCC" />
        </div>
        <!-- <h3 style="display: inline; opacity: 1;">
           Filter Analysis Data</h3> -->
        <!-- <button id="toggleFilterBtn" style="margin-left:20px; display: inline; opacity: 0.1;">Hide/Unhide</button> -->
        <!-- <div id="filterFormContainericon"></div> -->
        <div id="filterFormContainer">              
          
          <form id="filterForm">
          <table border="1" align="center">
          <tr>
            <TD>
              <label for="startTime">Start Time: </label>
              <input type="datetime-local" id="startTime" name="startTime" step="1" required>
            </TD>
            <TD>
              <label for="endTime">End Time: </label>
              <input type="datetime-local" id="endTime" name="endTime" step="1" required>
            </TD>
          </tr>
          <TR>
            <TD>
              <label for="initdistance">Starting KM: </label><input type="text" id="initdistance" name="starting km" value="0" required>
            </TD>
            <TD>
              <label for="direction">KM: </label>
              <select id="direction" name="direction" required>
                <option value="1">Increasing</option>
                <option value="-1">Decreasing</option>
              </select>
            </TD>
          </TR>
         
          <tr>
            <td colspan="2">
              <div>
                <b>Speed Restrictions (for analysis):</b>
                <table border="1" width="100%" id="filterSpeedRestrictionTable">
                  <thead>
                    <tr>
                      <th>Section</th>
                      <th>SR Speed</th>
                      <th>Start KM</th>
                      <th>End KM</th>
                      <th><button type="button" id="addFilterSpeedRestrictionRow">+</button></th>
                    </tr>
                  </thead>
                  <tbody id="filterSpeedRestrictionRows">
                  </tbody>
                </table>
              </div>
            </td>
          </tr>
           <tr>
            <td colspan="1" ><button type="submit" id="toggleFilterBtn2" style="width: 100%;">Hide Settings</button></td>
            <td colspan="1" ><button type="submit" id="toggleFilterBtn3" style="width: 100%;">Apply Setting</button></td>
          </tr>
          </table>
        </form>
      </div>
    </div>


    <div id="reportform" style="margin-bottom:20px;">
    <form>
      <table border="1" cellpadding="5" align="center" >
        <tr style="text-align: left;">
          <td>Journey Date:</td>
          <td><input type="text" id="form_journeyDate" name="journeyDate" value="" ></td>
          <td>Analysis Date:</td>
          <td><input type="text" id="reportId" name="reportId" value="" >
            <script>
                let d = new Date(), f = n => ('0' + n).slice(-2);
                document.getElementById('reportId').value = f(d.getDate()) + '/' + f(d.getMonth() + 1) + '/' + d.getFullYear();
            </script>
          </td>
        </tr>

        <tr>
          <td>LP Name/Desig/Headquater:</td>
          <td><input type="text"  id="form_lpName" name="lpName" value="" ></td>
          <td>ALP Name/Headquater:</td>
          <td><input type="text" id="form_alpName" name="alpName" value="" ></td>
        </tr>
        <tr>
          <td>Train No:</td>
          <td><input type="text" id="form_trainNo" name="trainNo" value="" ></td>
          <td>Loco Number/Base:</td>
          <td><input type="text" id="form_locoNumber" name="locoNumber" value="" ></td>
        </tr>
        <tr>
          <td>Type of Train:</td>
            <td>
            <select id="form_traintype" name="traintype" onchange="updateAnalysis()">
              <option value="Goods">Goods</option>
              <option value="Coaching">Coaching</option>
            </select>
            </td>
            <td>MPS:</td>
            <td><input type="text" id="form_Mps" name="Mps" value=""  onchange="updateAnalysis()"></td>
        </tr>
        <tr>
          <td>Assigned CLI:</td>
          <td><input type="text" id="form_assignedcli" name="assignedcli" value="" ></td>
          <td>Section:</td>
          <td><input type="text" id="form_section" name="section" value="" ></td>
        </tr>
        <tr>
          <td>Max Speed Attained:</td>
          <td><input type="text" id="form_topSpeed" name="form_topSpeed" value="" ></td>
          <td>Over Speeding:</td> <!-- if MPSattacned is more than MPS -->
          <td><input type="text" id="form_overSpeeding" name="overSpeeding" value="" ></td>
        </tr>
        <tr>
          <td>Total Distance:</td>
          <td><input type="text" id="form_totDistance" name="form_totDistance" value="" ></td>
          <td>Distance Near MPS:</td> <!-- Distance travelled near MPS i.e above 90% of MPS value-->
          <td><input type="text" id="form_distanceNearMps" name="distanceNearMps" value="" ></td>
        </tr>
        <tr>
          <td>Average Speed:</td>
          <td><input type="text" id="form_avgSpeed" name="form_avgSpeed" value="" ></td>
          <td>Time Range of Analysis:</td>
          <td><input type="text" id="form_timeRange" name="timeRange" value="" size="28" style="font-size: 0.8em; " ></td>
          
          
        </tr>
    
      <br>
  
        <!-- <tr> -->
          <!-- <td>Late Controlling:</td>
          <td><input type="text" id="form_lateControlling" name="lateControlling" value="" ></td> -->
          <!-- <td>Abrupt Breaking:</td>
          <td><input type="text" id="form_abruptBreaking" name="abruptBreaking" value="" ></td> -->
        <!-- </tr> -->
        <!-- <tr>
          
           <td>Poor Running:</td>
          <td><input type="text" id="form_poorRunning" name="poorRunning" value="" ></td> 
        </tr> -->
        <!-- <tr>
          <td>Improper BPT:</td>
          <td><input type="text" id="form_improperBpt" name="improperBpt" value="" ></td>
          <td>SR Overspeed:</td>
          <td><input type="text" id="form_srOverspeed" name="srOverspeed" value="" ></td>
        </tr> -->
        <tr>
          <td>BFT Time<input type="text" id="form_bfttime" name="bpttime" value="" size="15"></td>
          <td>Speed Drop <input type="text" id="form_bftspeeddrop" name="bftspeeddrop" value="" size="10"></td>
       
          <td>BPT Time<input type="text" id="form_bpttime" name="bpttime" value="" size="15"></td>
          <td>Speed Drop <input type="text" id="form_bptspeeddrop" name="bptspeeddrop" value="" size="10"></td>
          </tr>
      </table>
      <br>
    </form>

    </div>


    <div id="analysis" style="margin-bottom:20px;">
      <div style="display: flex; justify-content: center; text-align: center;">
        <h3 style="display: inline;">SPEED WHILE APPROACHING STOP SIGNAL AT DANGER</h3>
       <button id="toggleStopDetailsBtn" style="margin-left:20px; display: inline; opacity: 0.1;">Hide/Unhide</button>
      </div>
      <div id="stopDetailsContainer">
        <table border="1" cellpadding="5" cellspacing="0" align="center">
          <thead>
            <tr>
              <th>Stop #</th>
              <th>Stop Time</th>
              <th>Cumulative Distance at Stop (km)</th>
              <th>SPEEDB4 1000mtr</th>
              <th>SPEEDB4 500mtr</th>
              <th>SPEEDB4 100mtr</th>
              <th>SPEEDB4 10mtr</th>
              <!-- <th>SpeedatControlling/ BreakingDistance</th> -->
              <th>BREAKING Technique</th>
            </tr>
          </thead>
          <tbody id="stopDetails">
          </tbody>
        </table>
      </div>
    </div>

    <div id="analysis" style="margin-bottom:20px;">
      <div style="display: flex; justify-content: center; text-align: center;">
      <h3 >SPEED RESTRICTIONS OBSERVED BY THE LP</h3>
      <button id="toggleSpeedRestrictionBtn" style="margin-left:20px; display: inline; opacity: 0.1;">
        Hide/Unhide
      </button>
      <button id="AddRowSpeedRestrictionBtn" style="margin-left:20px; display: inline; opacity: 0.1;">
        Add Row
      </button>
    </div>
    
      <!-- Use inline style to allow horizontal scroll if needed (for screen only) -->
      <div id="speedRestrictionContainer" style="overflow-x: auto;">
        <table border="1" cellpadding="5" cellspacing="0" align="center" >
               <!-- style="width: 100%; table-layout: fixed;"> -->
    
          <colgroup>
            <col style="width: 15%;">
            <col style="width: 15%;">
            <col style="width: 15%;">
            <col style="width: 15%;">
            <col style="width: 15%;">
            <col style="width: 15%;">
            <col style="width: 5%;">
          </colgroup>
    
          <thead>
            <tr>
              <th>Section</th>
              <th>SR Specified Speed</th>
              <th>Start From</th>
              <th>End AT</th>
              <!-- <th>Avg Speed Observed</th> -->
              <!-- <th>Distance Travelled</th> -->
               <th colspan="2">Remakrs (Caution Observed/Not Observed)</th>
              <th><a onclick=addspeedRestrictiondataRow()>+</a></th>
            </tr>
          </thead>
          <tbody id="speedRestrictiondata">
          </tbody>
        </table>
      </div>
    </div>
    
    <div id="otherobservations" style="margin-bottom:20px;">
      <div style="display: flex; justify-content: center; text-align: center;">

      <h3 style="display: inline;">Irregularities and other Observations</h3>
        </div>
      <div id="otherobservationsContainer" style="">
        
          <table border="1" cellpadding="5" cellspacing="0" align="center"  
                  style=" width:100%;">   
            <thead>
              <tr>
                <th width="2%">S.No.</th>
                <th width="60%" colspan="4" >Irregularities and other observation</th>
                <th width="3%"><a onclick=addotherobservationdataRow()>+</a></th>
              </tr>
            </thead>
            <tbody id="otherobservationdata">
            </tbody>
          </table>
       </div> 
    </div>
    
    <div>
      <table align="right">
        <tr>
          <td>
            Analysis By:
          </td>
          <td>
            <textarea name="aa" style=" width:95%; height:30px; border:none " ></textarea>
          </td>
        </tr>
      </table>

    </div>



    
    <!-- Button controls -->
    <!-- <div style="margin-bottom:10px;">
      <button id="btnTimeSpeed">Time/Speed</button>
      <button id="btnDistanceSpeed">Distance/Speed</button>
      <button id="btnBoth">Both</button>
    </div> -->
    

    <br><br><br><br><br><br><br>

  </div>
    <!-- Chart containers -->
    <!-- <div id="chartdiv3" style="width: 100%; height: 500px;"></div> -->
    <div id="chartdiv" style="width: 100%; height: 500px;"></div>
    <div id="chartdiv2" style="width: 100%; height: 500px; display: none;"></div>

    <div id="bottom"></div>

    <script>
    // Global filtered data variable (default is full data)
    var filteredData = data.slice();

      function parseDateTime(str) {
        const [datePart, timePart] = str.split(" ");
        const [yy, mm, dd] = datePart.split("/").map(Number);
        const [hh, min, ss] = timePart.split(":").map(Number);
        return new Date(2000 + yy, mm - 1, dd, hh, min, ss);
      }


      function detectTest(data, config) {
        const {
          testName,
          speedMin,
          speedMax,
          dropMin,
          dropMax,
          requireRecovery
        } = config;

        const dataWithTime = data.map(d => ({
          ...d,
          timestamp: parseDateTime(d.datetime).getTime() / 1000
        }));

        // Filter for first 25 km (25000 meters) instead of 25 minutes
        const startDistance = dataWithTime[0].distance_cumm_positive;
        const first25Km = dataWithTime.filter(
          d => (d.distance_cumm_positive - startDistance) <= 25000
        );

        for (let i = 5; i < first25Km.length - 10; i++) {
          const candidate = first25Km[i];
          const candidateSpeed = candidate.kmph;

          // Candidate speed must be in valid range
          if (candidateSpeed < speedMin || candidateSpeed > speedMax) continue;

          // Phase A: Check for upward trend/fluctuation
          let hasPriorRise = false;
          for (let j = i - 5; j < i; j++) {
            if (first25Km[j].kmph < candidateSpeed) {
              hasPriorRise = true;
              break;
            }
          }
          if (!hasPriorRise) continue;

          // Phase B: Continuous drop
          let lowestSpeed = candidateSpeed;
          let dropEndIndex = i;

          for (let j = i + 1; j < first25Km.length; j++) {
            const currentSpeed = first25Km[j].kmph;

            if (currentSpeed <= lowestSpeed) {
              lowestSpeed = currentSpeed;
              dropEndIndex = j;
            } else {
              break; // drop interrupted
            }
          }

          const dropAmount = candidateSpeed - lowestSpeed;
          const dropRange = candidateSpeed + " → " + lowestSpeed;

          // Validate drop range
          if (dropAmount < dropMin || dropAmount > dropMax) continue;

          // Phase C: Recovery (if required)
          if (requireRecovery) {
            for (let k = dropEndIndex + 1; k < first25Km.length; k++) {
              if (first25Km[k].kmph >= candidateSpeed) {
                var result = {};
                result[testName + "_Point"] = candidate.datetime;
                result[testName + "_Drop_kmph"] = parseFloat(dropAmount.toFixed(2));
                result[testName +"_Drop_Range"] = dropRange;
                result[testName] = true;
                return result;
              }
            }
            continue; // drop valid but no recovery
          }

          // If recovery not required
            return {
            [testName]: true,
            [testName + "_Point"]: candidate.datetime,
            [testName + "_Drop_kmph"]: parseFloat(dropAmount.toFixed(2)),
            [testName + "_Drop_Range"]: dropRange
            };
        }

        return {
          [testName]: false,
          reason: "No valid " + testName + " pattern: rise → continuous drop (" + dropMin + "–" + dropMax + " kmph from " + speedMin + "–" + speedMax + ")",
          [testName + "_Point"]: null,
          [testName + "_Drop_kmph"]: null,
          [testName + "_Drop_Range"]: null
        };
      }
        
    // Limits for Coaching and Goods
    var limits = {
      "1000mtr": { "Coaching": 50, "Goods": 30 },
      "500mtr": { "Coaching": 50, "Goods": 30 },
      "100mtr": { "Coaching": 10, "Goods": 5 },
      "10mtr": { "Coaching": 10, "Goods": 5 }
    };

    function getSpeedColor(type, meter, speed) {
      if (!limits[meter]) {
        console.warn('Meter "${meter}" not found in limits.');
        return "black"; // Default color if meter is not found
      }
      if (!limits[meter][type]) {
        console.warn('Type "${type}" not found for meter "${meter}" in limits.');
        return "black"; // Default color if type is not found
      }
      return speed > limits[meter][type] ? "red" : "green";
    }
    
    // Global variables for charts
    var timeSpeedChart = null;
    var distanceChart = null;
    var combinedChart = null;

    // Utility function to format Date to "YYYY-MM-DDTHH:MM:SS" for datetime-local input
    function formatDateTimeLocal(date) {
        var yyyy = date.getFullYear();
        var MM = ('0' + (date.getMonth() + 1)).slice(-2);
        var dd = ('0' + date.getDate()).slice(-2);
        var hh = ('0' + date.getHours()).slice(-2);
        var mm = ('0' + date.getMinutes()).slice(-2);
        var ss = ('0' + date.getSeconds()).slice(-2);
        return yyyy + '-' + MM + '-' + dd + 'T' + hh + ':' + mm + ':' + ss;
    }
    
    // Set default values for filter inputs based on data's first and last entries
    var firstDate = data[0].date;
    var lastDate = data[data.length - 1].date;
    document.getElementById("startTime").value = formatDateTimeLocal(firstDate);
    document.getElementById("startTime").min = formatDateTimeLocal(firstDate);
    document.getElementById("startTime").max = formatDateTimeLocal(lastDate);
    
    document.getElementById("endTime").value = formatDateTimeLocal(lastDate);
    document.getElementById("endTime").min = formatDateTimeLocal(firstDate);
    document.getElementById("endTime").max = formatDateTimeLocal(lastDate);
    
    // Function to update charts with filteredData
    function updateCharts() {
        if(timeSpeedChart) {
            createSpeedChart();
        }
        if(distanceChart) {
            distanceChart.data = filteredData;
        }
    }

    function calculateDistanceNearTopSpeed(filteredData, topSpeedValue) {
        const thresholdSpeed = topSpeedValue * 0.95; 
        let totalDistance = 0;

        for (let i = 1; i < filteredData.length; i++) {
          const currentSpeed = filteredData[i].kmph;
          const previousDistance = filteredData[i - 1].distance_cumm;
          const currentDistance = filteredData[i].distance_cumm;

          if (currentSpeed >= thresholdSpeed) {
            totalDistance += Math.abs(currentDistance - previousDistance);
          }
        }

        return (totalDistance / 1000).toFixed(3); 
      }
    
      // Helper: get all speed restriction inputs from filter form
    function getSpeedRestrictionInputs() {
   //   console.log("getSpeedRestrictionInputs called.")
      const rows = document.querySelectorAll('#filterSpeedRestrictionRows tr');
     // console.log("getSpeedRestrictionInputs rows:."+ rows);
      const restrictions = [];
      let sectionCounter = 1;
      rows.forEach(row => {
        let section = row.querySelector('input[name="filter_section"]')?.value.trim();
        // Extract number from text (e.g., "80.0 KM" => 80.0)
        const srSpeedText = row.querySelector('input[name="filter_srSpeed"]')?.value;
        const srSpeedMatch = srSpeedText && srSpeedText.match(/[\d.]+/);
        const srSpeed = srSpeedMatch ? parseFloat(srSpeedMatch[0]) + 2 : NaN;

        // const startFromText = row.querySelector('input[name="filter_startFrom"]')?.value;
	
        // const startFromMatch = startFromText && startFromText.match(/[\d.]+/);
        // const startFrom = startFromMatch ? parseFloat(startFromMatch[0]) : NaN;

	const startFromtext = row.querySelector('input[name="filter_startFrom"]')?.value || '';
	const startFromval = startFromtext.replace(/[^\d./]/g, '').split('/');	
	var startFrom = startFromval.length === 2
	  ? (v => v[1]/32 > 1 ? v[0]+1.0 : v[0] + v[1]/32)(startFromval.map(parseFloat))
	  : parseFloat(startFromval[0]) || 0.0;
	 startFrom = parseFloat(startFrom) + 0.075;

        // const endAtText = row.querySelector('input[name="filter_endAt"]')?.value;
        // const endAtMatch = endAtText && endAtText.match(/[\d.]+/);
        // const endAt = endAtMatch ? parseFloat(endAtMatch[0]) : NaN;

	const endAttext = row.querySelector('input[name="filter_endAt"]')?.value || '';
	const endAtval = endAttext.replace(/[^\d./]/g, '').split('/');
	var endAt = endAtval.length === 2
	  ? (v => v[1]/32 > 1 ? v[0] + 1.0 : v[0] + v[1]/32)(endAtval.map(parseFloat))
	  : parseFloat(endAtval[0]) || 0.0;
	endAt = endAt + 0.025;

        if (!section) {
          section = sectionCounter.toString();
          sectionCounter++;
        }

        if (!isNaN(srSpeed) && !isNaN(startFrom) && !isNaN(endAt)) {
          restrictions.push({ section, srSpeed, startFrom, endAt ,startFromtext, endAttext });
        }
      });
      return restrictions;
    }
      
    // Autofill the SPEED RESTRICTIONS OBSERVED BY THE LP table
    function autofillSpeedRestrictionTable() {
        // console.log("autofillSpeedRestrictionTable function was called:" );
        const tableBody = document.getElementById('speedRestrictiondata');
        // Remove all rows except the ones with manual edits (those with data-manual="true")
        tableBody.querySelectorAll('tr').forEach(row => {
       //   console.log("Row has stribute data manual"+ row.hasAttribute('data-manual'));
          if (row.hasAttribute('data-manual') )
          {
              row.remove();
          }
        });

        const restrictions = getSpeedRestrictionInputs();
      //  console.log(restrictions);
        restrictions.forEach(restriction => {
          // Check if speed ever exceeds SR Speed in the specified range
          const minKM = Math.min(restriction.startFrom, restriction.endAt);
          const maxKM = Math.max(restriction.startFrom, restriction.endAt);
          const minMeter = minKM * 1000;
          const maxMeter = maxKM * 1000;
          const exceeded = filteredData.some(d =>
            d.distance_cumm_positive >= minMeter &&
            d.distance_cumm_positive <= maxMeter &&
            d.kmph > restriction.srSpeed
          );
          const remarks = exceeded ? "Not Observed (pls confirm by manual check)" : "Observed";

          // Create row
          const newRow = document.createElement('tr');
            newRow.innerHTML =
            '<td><input type="text" name="section" style="width:95%;" value="' + restriction.section + '" /></td>' +
            '<td><input type="text" name="srSpeed" style="width:95%;" value="' + restriction.srSpeed + '" /></td>' +
            '<td><input type="text" name="startFrom" style="width:95%;" value="' + restriction.startFromtext + '" /></td>' +
            '<td><input type="text" name="endAt" style="width:95%;" value="' + restriction.endAttext + '" /></td>' +
            '<td colspan="2"><input type="text" name="remarks" style="width:95%;" value="' + remarks + '" /></td>' +
            '<td><button type="button" style="cursor:pointer;">-</button></td>';
          // Allow manual removal
          newRow.querySelector('button').onclick = function() { newRow.remove(); };
          // Mark as autofilled (not manual)
          newRow.setAttribute('data-manual', 'false');
          tableBody.appendChild(newRow);
        });
      }

    // Function to update analysis table based on filteredData
    function updateAnalysis() {
        // Top speed calculation
        var topSpeedValue = "N/A";
        var totalDistanceValue= "N/A";
        var avgSpeed= "N/A";
        var journeyDate ="N/A";

        var direction = parseFloat(document.getElementById("direction").value);
        //var initdistancemeters = direction * Math.abs(parseFloat(document.getElementById("initdistance").value)*1000);
	var initdistancemeters = 0.0;
	const initdistancemeterstext = document.getElementById("initdistance")?.value || '0';
	const initdistancemetersval = initdistancemeterstext.replace(/[^\d./]/g, '').split('/');
	//console.log(initdistancemetersval);
	if (initdistancemetersval.length >= 2){
		var initdistno=parseFloat(initdistancemetersval[0]);
		var initdistfr=parseFloat(initdistancemetersval[1]);
		initdistfr = initdistfr/32.0;
		if (initdistfr > 1){
			initdistfr = 1.0;
		}
		initdistancemeters= initdistno + initdistfr;
	}else{
		initdistancemeters= parseFloat(initdistancemetersval[0]);
	}
	initdistancemeters = direction * Math.abs(initdistancemeters*1000); // converting to actual meters

	//console.log(initdistancemeters);
	    
        initdistance1 = initdistancemeters;
        filteredData.forEach(function(item) {
            item.distance_cumm = item.distance_meters + initdistance1
            initdistance1 = item.distance_cumm
            item.distance_cumm_positive = Math.abs(item.distance_cumm);
            item.distance_cumm_positive_comma = (parseFloat(item.distance_cumm_positive) / 1000).toFixed(3);
        });

        if(filteredData.length > 0) {
            journeyDate = filteredData[0].date.toLocaleDateString('en-GB');
            topSpeedValue = Math.max.apply(null, filteredData.map(function(d){ return d.kmph; }));
            totalDistanceValue = parseFloat(filteredData[filteredData.length-1].distance_cumm - initdistancemeters)/1000;
        }

        if (filteredData.length > 1) {
          var totalTimeInSeconds = (filteredData[filteredData.length - 1].date - filteredData[0].date) / 1000;
          avgSpeed = ((totalDistanceValue / totalTimeInSeconds) * 3600).toFixed(3); // Convert m/s to km/h and restrict to 3 decimal places
        }


        document.getElementById('form_avgSpeed').value=avgSpeed + " KMPH";
        document.getElementById('form_totDistance').value = totalDistanceValue + " KM";
        document.getElementById('form_topSpeed').value = topSpeedValue + " KMPH";
        document.getElementById('form_journeyDate').value = journeyDate;

        var form_mps = parseInt(document.getElementById('form_Mps').value.replace(/\D/g, ''), 10) || 200;
        if( form_mps < topSpeedValue){
            document.getElementById('form_topSpeed').style.color = "red";
            document.getElementById('form_overSpeeding').value="Yes"
            document.getElementById('form_overSpeeding').style.color = "red";
        }else{
          document.getElementById('form_topSpeed').style.color = "green";
          document.getElementById('form_overSpeeding').value="No"
          document.getElementById('form_overSpeeding').style.color = "green";
        }
        const distanceNearTopSpeed = calculateDistanceNearTopSpeed(filteredData, form_mps);
        if(distanceNearTopSpeed > 0){
          document.getElementById('form_distanceNearMps').value = distanceNearTopSpeed + " KM";
        }else{
          document.getElementById('form_distanceNearMps').value = "";
        }


        // Counting stops (consecutive two or more zeros) and capturing each stop index
        var totalStops = 0;
        var stopIndices = [];
        for (var i = 0; i < filteredData.length; i++) {
            if (filteredData[i].kmph === 0) {
                // If this is the first stop, just add it
                if (stopIndices.length === 0) {
                    stopIndices.push(i);
                    totalStops++;
                } else {
                  var lastStopIdx = stopIndices[stopIndices.length - 1];
                  var lastStopDist = filteredData[lastStopIdx].distance_cumm;
                  var currDist = filteredData[i].distance_cumm;
                  var lastStopTime = filteredData[lastStopIdx].date;
                  var currTime = filteredData[i].date;
                  var timeDiffSeconds = Math.abs((currTime - lastStopTime) / 1000);
                  // If current stop is within 200 meters OR within 2 minutes (120 seconds) of last, overwrite last with current
                  if (Math.abs(currDist - lastStopDist) < 200 && timeDiffSeconds < 60) {
                    stopIndices[stopIndices.length - 1] = i;
                  } else {
                    stopIndices.push(i);
                    totalStops++;
                  }
                }
                // Skip consecutive zeros
                while (i < filteredData.length && filteredData[i].kmph === 0) {
                    i++;
                }
                i--; // adjust for loop increment
            }
        }
        
        // Clear stop details table
        var stopDetailsBody = document.getElementById("stopDetails");
        stopDetailsBody.innerHTML = "";
        
        // For each stop, compute max speed before stop within 100m and 1000m windows
        stopIndices.forEach(function(idx, index) {
            var stopData = filteredData[idx];
            var stopDistance = stopData.distance_cumm;
            var stopDistancePositive = stopData.distance_cumm_positive
            var stopTime = stopData.date; // stop time
            
            // Define window start for 100m and 1000m before stop
            var windowStart100 =  stopDistance - 100;
            var windowStart1000 =  stopDistance - 1000;
            var windowStart500  = stopDistance - 500;
            var windowStart10 = stopDistance - 10;
            
            // Filter data points in the respective windows (excluding the stop point)
            var windowData100 = filteredData.filter(function(d) {
                return d.distance_cumm >= windowStart100 && d.distance_cumm < stopDistance;
            });

            var windowData1000 = filteredData.filter(function(d) {
                return d.distance_cumm >= windowStart1000 && d.distance_cumm < stopDistance;
            });

            var windowData500 = filteredData.filter(function(d) {
                return d.distance_cumm >= windowStart500 && d.distance_cumm < stopDistance;
            });

            var windowData10 = filteredData.filter(function(d) {
                return d.distance_cumm >= windowStart10 && d.distance_cumm < stopDistance;
            });
            
            var localMax100 = windowData100.length > 0 ? Math.max.apply(null, windowData100.map(function(d){ return d.kmph; })) : "N/A";
            var localMax1000 = windowData1000.length > 0 ? Math.max.apply(null, windowData1000.map(function(d){ return d.kmph; })) : "N/A";
            var localMax10 = windowData10.length > 0 ? Math.max.apply(null, windowData10.map(function(d){ return d.kmph; })) : "N/A";
            var localMax500 = windowData500.length > 0 ? Math.max.apply(null, windowData500.map(function(d){ return d.kmph; })) : "N/A";

            // Append a new row for this stop
            var row = document.createElement("tr");
            
            var cellStopNumber = document.createElement("td");
            cellStopNumber.innerText = index + 1;
            
            var cellStopTime = document.createElement("td");
            cellStopTime.innerText = new Date(stopTime).toLocaleString('en-GB');
            
            var cellStopDistance = document.createElement("td");
            cellStopDistance.innerText = (parseFloat(stopDistancePositive) / 1000).toFixed(3);

            var type = document.getElementById("form_traintype").value;
            var breakingtechnique = "Smooth";

            var cellMax1000 = document.createElement("td");
            cellMax1000.innerText = localMax1000;
            var color = getSpeedColor(type, "1000mtr" , localMax1000);
            cellMax1000.style.color = color;
            if(color == "red"){breakingtechnique="Late"}            

            var cellMax500 = document.createElement("td");
            cellMax500.innerText = localMax500;
            var color = getSpeedColor(type, "500mtr" , localMax500);
            cellMax500.style.color = color;
            if(color == "red"){breakingtechnique="Late"}

            var cellMax100 = document.createElement("td");
            cellMax100.innerText = localMax100;
            var color = getSpeedColor(type, "100mtr" , localMax100);
            cellMax100.style.color = color;
            if(color == "red"){breakingtechnique="Late"}

            var cellMax10 = document.createElement("td");
            cellMax10.innerText = localMax10;
            var color = getSpeedColor(type, "10mtr" , localMax10);
            cellMax10.style.color = color;
            if(color == "red"){breakingtechnique="Late"}
            
            var cellbreakingtechnique = document.createElement("td");
            cellbreakingtechnique.innerHTML = "<input type=text name=breakingtechnique value="+breakingtechnique+">"

            // --- Add remove button cell ---
            var cellRemove = document.createElement("td");
            var removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.textContent = "-";
            removeBtn.style.cursor = "pointer";
            removeBtn.onclick = function() {
              row.remove();
            };
            cellRemove.appendChild(removeBtn);

            row.appendChild(cellStopNumber);
            row.appendChild(cellStopTime);
            row.appendChild(cellStopDistance);
            row.appendChild(cellMax1000);
            row.appendChild(cellMax500);
            row.appendChild(cellMax100);
            row.appendChild(cellMax10);
            row.appendChild(cellbreakingtechnique);
            row.appendChild(cellRemove); // <-- Add the remove button cell

            stopDetailsBody.appendChild(row);
        });

        try {
          var BPT_INFO = detectTest(filteredData, {
            testName: 'BPT',
            speedMin: 40,
            speedMax: 120,
            dropMin: 15,
            dropMax: 100,
            requireRecovery: false
          });

          var BFT_INFO = detectTest(filteredData, {
            testName: 'BFT',
            speedMin: 9,
            speedMax: 20,
            dropMin: 4,
            dropMax: 20,
            requireRecovery: true
          });

          if (BFT_INFO.BFT == true) {
            document.getElementById("form_bfttime").value = BFT_INFO.BFT_Point;
            document.getElementById("form_bftspeeddrop").value = BFT_INFO.BFT_Drop_Range;
          }else{
            document.getElementById("form_bfttime").value = "";
            document.getElementById("form_bftspeeddrop").value = "";
          }
          if (BPT_INFO.BPT == true) {
            document.getElementById("form_bpttime").value = BPT_INFO.BPT_Point;
            document.getElementById("form_bptspeeddrop").value = BPT_INFO.BPT_Drop_Range;
          }else{
            document.getElementById("form_bpttime").value = "";
            document.getElementById("form_bptspeeddrop").value = "";
          }
        } catch (error) {
          console.error("An error occurred while detecting tests:", error);
        }

      var form_timeRange=document.getElementById("form_timeRange");
      if (filteredData.length > 0) {
        var startTime = filteredData[0].date.toLocaleString('en-GB', { year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        var endTime = filteredData[filteredData.length - 1].date.toLocaleString('en-GB', { year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        form_timeRange.value = startTime + " - " + endTime;
      } else {
        form_timeRange.value = "";
      }

      autofillSpeedRestrictionTable();

    }
    
    // update Analysis End

    // Filter form event listener
    document.getElementById("filterForm").addEventListener("submit", function(e) {
        e.preventDefault();
        var startInput = document.getElementById("startTime").value;
        var endInput = document.getElementById("endTime").value;
        var startTime = new Date(startInput);
        var endTime = new Date(endInput);
        
        // Validate that the inputs are within allowed range
        if(startTime < firstDate) startTime = firstDate;
        if(endTime > lastDate) endTime = lastDate;
        if(startTime > endTime) {
            alert("Start time cannot be after End time.");
            return;
        }
        
        // Filter the data
        filteredData = data.filter(function(d) {
            return d.date >= startTime && d.date <= endTime;
        });  

        // After filteredData is set, add last stop entry if not there already:
        if (
          filteredData.length > 0 &&
          filteredData[filteredData.length - 1].kmph <= 2
        ) {
        // Clone the last entry
          var last = filteredData[filteredData.length - 1];
          // Parse the datetime and add 1 second
          var parts = last.datetime.split(/[/ :]/);
          var dt = new Date(
            2000 + parseInt(parts[2], 10),
            parseInt(parts[1], 10) - 1,
            parseInt(parts[0], 10),
            parseInt(parts[3], 10),
            parseInt(parts[4], 10),
            parseInt(parts[5], 10)
          );
          dt.setSeconds(dt.getSeconds() + 1);

          // Format new datetime as "DD/MM/YY HH:mm:ss"
          var pad = n => n.toString().padStart(2, '0');
          var newDatetime =
            pad(dt.getDate()) +
            '/' +
            pad(dt.getMonth() + 1) +
            '/' +
            (dt.getFullYear() % 100) +
            ' ' +
            pad(dt.getHours()) +
            ':' +
            pad(dt.getMinutes()) +
            ':' +
            pad(dt.getSeconds());

          // Create new entry
          var newEntry = {
            datetime: newDatetime,
            kmph: 0,
            distance_meters: 0
          };
          // Add date property for consistency
          newEntry.date = new Date(dt);

          filteredData.push(newEntry);
        }


        // Update charts and analysis
        updateAnalysis();
        updateCharts();
    });
    
    // Initial analysis update
    updateAnalysis();
    
    // Initialize Time/Speed Chart
  //  am4core.ready(function() {
    function createSpeedChart(){
        am4core.useTheme(am4themes_animated);

        // Create chart instance for Time/Speed graph and store in global variable
        timeSpeedChart = am4core.create("chartdiv", am4charts.XYChart);

        // Add data
        timeSpeedChart.data = filteredData;

        // Create axes
        var dateAxis = timeSpeedChart.xAxes.push(new am4charts.DateAxis());
        dateAxis.renderer.minGridDistance = 50;

        dateAxis.renderer.labels.template.adapter.add("textOutput", function(text, target) {
          // Check if the label is associated with a data item (tick)
              if(target.dataItem && target.dataItem.date){
              // Get the tick's date (as a Date object)
              var tickDate = target.dataItem.date;

              // Find the matching data item in filteredData based on the date.
              // This assumes an exact match (use caution with time precision)
              var foundItem = filteredData.find(function(item) {
                return new Date(item.date).getTime() === tickDate.getTime();
              });
              if(foundItem && foundItem.distance_cumm_positive_comma){
                // Append the extra text from the data item.
                return text + " \n" + foundItem.distance_cumm_positive_comma;
              }
            }
            return text;
          });


        var valueAxis = timeSpeedChart.yAxes.push(new am4charts.ValueAxis());

        // Create series
        var series = timeSpeedChart.series.push(new am4charts.LineSeries());
        series.dataFields.valueY = "kmph";
        series.dataFields.dateX = "date";
        series.dataFields.valueX = "distance_cumm";
        series.strokeWidth = 2;
        series.tooltipText = "Speed: {valueY} km/h\nTime: {dateX.formatDate('HH:mm:ss')}\nDistance: {distance_cumm_positive_comma} km";
        series.tooltip.pointerOrientation = "vertical";
        series.tooltip.background.cornerRadius = 20;
        series.tooltip.background.fillOpacity = 0.3;
        series.tooltip.dy = -20;
        series.tooltip.label.padding(12,12,12,12);

        // Add scrollbar (if needed, not related to distance labels)
        timeSpeedChart.scrollbarX = new am4charts.XYChartScrollbar();
        timeSpeedChart.scrollbarX.series.push(series);

        // Add cursor
        timeSpeedChart.cursor = new am4charts.XYCursor();
        timeSpeedChart.cursor.xAxis = dateAxis;
        timeSpeedChart.cursor.snapToSeries = series;

        dateAxis.tooltip.label.adapter.add("textOutput", function(text, target) {
          //console.log(text, target.dataItem);
          var foundItem = filteredData.find(function(item) {
                return item.datetime.includes(text);
              });
          if(foundItem && foundItem.distance_cumm_positive_comma){
            // Append the extra text from the data item.
            return text + " \n" + foundItem.distance_cumm_positive_comma;
          }

          return text;
        });
    };

    /* Create Distance Graph */
    function createDistanceChart(){
      if(!distanceChart) {
        distanceChart = am4core.create("chartdiv2", am4charts.XYChart);
        distanceChart.data = filteredData;
        
        // Create x-axis for cumulative distance
        var xAxis = distanceChart.xAxes.push(new am4charts.ValueAxis());
        xAxis.title.text = "Distance (cumulative meters)";
        
        // Create y-axis for speed
        var yAxis = distanceChart.yAxes.push(new am4charts.ValueAxis());
        yAxis.title.text = "Speed (kmph)";
        
        // Create series for Distance/Speed chart
        var series = distanceChart.series.push(new am4charts.LineSeries());
        series.dataFields.valueX = "distance_cumm";
        series.dataFields.valueY = "kmph";
        series.strokeWidth = 2;
        series.tooltipText = "Speed: {valueY} km/h\nTime: {date.formatDate('HH:mm:ss')}\nDistance: {distance_cumm} m";;;
        
        // Add scrollbar
        distanceChart.scrollbarX = new am4charts.XYChartScrollbar();
        distanceChart.scrollbarX.series.push(series);
        
        // Add cursor
        distanceChart.cursor = new am4charts.XYCursor();
        distanceChart.cursor.snapToSeries = series;
      }else{
        updateCharts();
      }
    }

    createSpeedChart();
    // Button event listeners

    // Show only Time/Speed graph
    // document.getElementById("btnTimeSpeed").addEventListener("click", function() {
    //   document.getElementById("chartdiv").style.display = "block";
    //   document.getElementById("chartdiv2").style.display = "none";
    //   createSpeedChart();
    // });
    
    // // Show only Distance/Speed graph (create it if needed)
    // document.getElementById("btnDistanceSpeed").addEventListener("click", function() {
    //   document.getElementById("chartdiv").style.display = "none";
    //   document.getElementById("chartdiv2").style.display = "block";
    //   createDistanceChart();
    // });
    
    // // Show both graphs
    // document.getElementById("btnBoth").addEventListener("click", function() {
    //   document.getElementById("chartdiv").style.display = "block";
    //   document.getElementById("chartdiv2").style.display = "block";
    //   createSpeedChart();
    //   createDistanceChart();
    // });
    
    // Toggle stop details visibility
    document.getElementById("toggleStopDetailsBtn").addEventListener("click", function() {
      var container = document.getElementById("stopDetailsContainer");
      if (container.style.display === "none" || container.style.display === "") {
        container.style.display = "block";
      } else {
        container.style.display = "none";
      }
    });
    document.getElementById("stopDetailsContainer").style.display = "block";

    function hidecontainer() {
      var container = document.getElementById("filterFormContainer");
      if (container.style.display === "none" || container.style.display === "") {
      container.style.display = "block";
      } else {
      container.style.display = "none";
      }
    }

    document.getElementById("toggleFilterBtn").addEventListener("click",hidecontainer );
    document.getElementById("toggleFilterBtn2").addEventListener("click",hidecontainer );
    document.getElementById("toggleFilterBtn3").addEventListener("click",hidecontainer );
	    
    document.getElementById("filterFormContainer").style.display = "block";

    document.getElementById('toggleSpeedRestrictionBtn').addEventListener('click', function() {
    var speedRestrictionDiv = document.getElementById('speedRestrictionContainer');
    if (speedRestrictionDiv.style.display === 'none') {
      speedRestrictionDiv.style.display = 'block';
    } else {
      speedRestrictionDiv.style.display = 'none';
    }
  });

  document.getElementById("speedRestrictionContainer").style.display = "block";

  function addspeedRestrictiondataRow() {
    var tableBody = document.getElementById('speedRestrictiondata');
    var newRow = document.createElement('tr');

    // Create cells with text fields
    var sectionCell = document.createElement('td');
    sectionCell.innerHTML = '<input type="text" name="section" style="width:95%;" />';
    newRow.appendChild(sectionCell);

    var srSpeedCell = document.createElement('td');
    srSpeedCell.innerHTML = '<input type="text" name="srSpeed" style="width:95%;" />';
    newRow.appendChild(srSpeedCell);

    var startFromCell = document.createElement('td');
    startFromCell.innerHTML = '<input type="text" name="startFrom" style="width:95%;" />';
    newRow.appendChild(startFromCell);

    var endAtCell = document.createElement('td');
    endAtCell.innerHTML = '<input type="text" name="endAt" style="width:95%;" />';
    newRow.appendChild(endAtCell);

    // var avgSpeedObsCell1 = document.createElement('td');
    // avgSpeedObsCell1.innerHTML = '<input type="text" name="avgSpeedObs1" style="width:95%;" />';
    // newRow.appendChild(avgSpeedObsCell1);

    // var avgSpeedObsCell2 = document.createElement('td');
    // avgSpeedObsCell2.innerHTML = '<input type="text" name="avgSpeedObs2" style="width:95%;" />';
    // newRow.appendChild(avgSpeedObsCell2);

    var remarksCell = document.createElement('td');
    remarksCell.setAttribute('colspan', '2');
    remarksCell.innerHTML = '<input type="text" name="remarks" style="width:95%;"></input>';
    newRow.appendChild(remarksCell);

    // Create remove button
    var removeCell = document.createElement('td');
    var removeButton = document.createElement('button');
    removeButton.textContent = '-';
    removeButton.style.cursor = 'pointer';
    removeButton.addEventListener('click', function() {
      newRow.remove(); // remove this row
    });
    removeCell.appendChild(removeButton);
    newRow.appendChild(removeCell);

    // Append the row to the table body
    tableBody.appendChild(newRow);
  }
  // Add a new row to the table when the "Add Row" button is clicked
  document.getElementById('AddRowSpeedRestrictionBtn').addEventListener('click',addspeedRestrictiondataRow );
  if(!final_report)
  {
    addspeedRestrictiondataRow();
  }

  // addspeedRestrictiondataRow();

  function addotherobservationdataRow() {
    var tableBody = document.getElementById('otherobservationdata');
    var newRow = document.createElement('tr');

    // Create cells with text fields
    var sectionCell = document.createElement('td');
    sectionCell.innerHTML = '<input type="text" name="sno" style="width:95%; box-sizing: border-box;" />';
    newRow.appendChild(sectionCell);

    var srSpeedCell = document.createElement('td');
    srSpeedCell.setAttribute('colspan', '4');
    srSpeedCell.innerHTML = '<textarea name="observation" style=" width:95%; height:60px; box-sizing: border-box; resize:vertical" ></textarea>';
    newRow.appendChild(srSpeedCell);

    // Create remove button
    var removeCell = document.createElement('td');
    var removeButton = document.createElement('button');
    removeButton.textContent = '-';
    removeButton.style.cursor = 'pointer';
    removeButton.addEventListener('click', function() {
      newRow.remove(); // remove this row
    });
    removeCell.appendChild(removeButton);
    newRow.appendChild(removeCell);

    // Append the row to the table body
    tableBody.appendChild(newRow);
  }

  if(!final_report)
  {
    addotherobservationdataRow();
  }


  function populateBottomDiv() {
      const bottomDiv = document.getElementById("bottom");
      if (!bottomDiv) return;
      bottomDiv.style.backgroundColor = "#333";
      bottomDiv.style.color = "#f1f1f1";
      bottomDiv.style.position = "relative";
      bottomDiv.style.height = "50px";
      bottomDiv.style.fontSize = "15px";

      bottomDiv.innerHTML = "<table width='100%' style='height: 100%;'>" +
        "<tr>" +
          "<td width='25%'>" +
        "Inspiration: Mr. Mukesh (PCEE/WCR/JBP)" +
          "</td>" +
          "<td width='25%'>" +
        "Motivation: Mr. Devashish Tripathi (DRM/BPL)" +
          "</td>" +
          "<td width='50%'>" +
        "Developed under the guidance of Mr. Surendra Srivastava. For any suggestion or issues, " +
        "<a href='https://wa.me/+919752417440' " +
          "style='color: #f1f1f1; text-decoration: none;'>" +
          "whatsapp at: 9752417440" +
        "</a>" +
          "</td>" +
        "</tr>" +
      "</table>";
    }

    populateBottomDiv();
    </script>

    <script>


    </script>

    <!-- --- Place this after your other <script> blocks --- -->

    <!-- Add row to filter form's speed restriction input table -->
    <script>
function addFilterSpeedRestrictionRow(section="", srSpeed="", startFrom="", endAt="") {
  var tbody = document.getElementById('filterSpeedRestrictionRows');
  var tr = document.createElement('tr');
  tr.innerHTML =
    '<td><input type="text" name="filter_section" style="width:95%;" value="' + section + '"></td>' +
    '<td><input type="text" name="filter_srSpeed" style="width:95%;" value="' + srSpeed + '"></td>' +
    '<td><input type="text" name="filter_startFrom" style="width:95%;" value="' + startFrom + '"></td>' +
    '<td><input type="text" name="filter_endAt" style="width:95%;" value="' + endAt + '"></td>' +
    '<td><button type="button" onclick="this.closest(\'tr\').remove()">-</button></td>';
  tbody.appendChild(tr);
}
document.getElementById('addFilterSpeedRestrictionRow').onclick = function() {
  addFilterSpeedRestrictionRow();
};
// Add one empty row by default

  if(!final_report)
  {
  addFilterSpeedRestrictionRow();
  }


    </script>
<button id="downloadHtmlBtn"
  style="
    position: fixed;
    top: 10px;
    right: 120px;
    z-index: 9999;
    padding: 8px 18px;
    font-size: 1em;
    background: #1976d2;
    color: #fff;
    border: none;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: background 0.2s;
  "
  onmouseover="this.style.background='#125ea2'"
  onmouseout="this.style.background='#1976d2'"
>
  Save Report
</button>

<!-- Print Button -->
<button id="printReportBtn"
  style="
    position: fixed;
    top: 10px;
    right: 20px;
    z-index: 9999;
    padding: 8px 18px;
    font-size: 1em;
    background: #388e3c;
    color: #fff;
    border: none;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: background 0.2s;
  "
  onmouseover="this.style.background='#256b28'"
  onmouseout="this.style.background='#388e3c'"
>
  Print
</button>
<script>
document.getElementById('printReportBtn').onclick = function() {
  hidecontainer();
  window.print();
};
document.getElementById('downloadHtmlBtn').onclick = function() {
  // 1. Set final_report to true in the downloaded HTML
  var scripts = document.querySelectorAll('script');
  scripts.forEach(function(script) {
    if (script.textContent.includes('var final_report=false;')) {
      script.textContent = script.textContent.replace('var final_report=false;', 'var final_report=true;');
    }
  });

  // 2. Update all input/textarea/select elements' defaultValue/defaultSelected to current value
  document.querySelectorAll('input, textarea, select').forEach(function(el) {
    if (el.tagName === 'INPUT' && (el.type === 'text' || el.type === 'number' || el.type === 'datetime-local')) {
      el.setAttribute('value', el.value);
    }
    if (el.tagName === 'TEXTAREA') {
      el.innerHTML = el.value;
    }
    if (el.tagName === 'SELECT') {
      Array.from(el.options).forEach(function(opt) {
        if (opt.value == el.value) opt.setAttribute('selected', 'selected');
        else opt.removeAttribute('selected');
      });
    }
  });

  // 3. Serialize the DOM
  var html = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;

  // 4. Check for the data block before replacing

  var dataBlockRegex1 = "data=\\/\\*data DO NOT REMOVE THIS COMMENT\\*\\/\\n";
  var dataBlockRegex2 = "\\/\\*data_end DO NOT REMOVE THIS COMMENT\\*\\/"

  var match1 = html.match(dataBlockRegex1);
  //console.log("aa:" + match1);
  var match2 = html.match(dataBlockRegex2);
  //console.log("bb::" + match2);
  var filteredDataStr = JSON.stringify(filteredData, null, 2);

  var startIdx = html.indexOf("data=/*data DO NOT REMOVE THIS COMMENT*/");
  var endIdx = html.indexOf("/*data_end DO NOT REMOVE THIS COMMENT*/", startIdx);
  if (startIdx !== -1 && endIdx !== -1) {
    var before = html.substring(0, startIdx + "data=/*data DO NOT REMOVE THIS COMMENT*/".length);
    var after = html.substring(endIdx);
    html = before + "\n" + filteredDataStr + "\n" + after;
  }
  // 6. Download as before
  var blob = new Blob([html], {type: "text/html"});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  var fileName = "analysis_report";
  try {
    var path = window.location.pathname || "";
    var matchFile = path.match(/([^\/\\]+)\.html?$/i);
    if (matchFile && matchFile[1]) {
      fileName = matchFile[1] + "_analysed";
    }
  } catch (e) { console.log(e); }
  try{

	journeydate=document.getElementById('form_journeyDate').value.replaceAll('/','_');
	lpname=document.getElementById('form_lpName').value.replaceAll(' ','_').replaceAll('/','_');  
	trainno=document.getElementById('form_trainNo').value.replaceAll(' ','_').replaceAll('/','_');
	fileName=journeydate+'_'+lpname+'_'+trainno;	  
  }catch(e) { console.log(e); }
  a.download = fileName + ".html";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
};
</script>
  </body>
</html>
